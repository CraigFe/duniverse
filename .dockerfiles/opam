ARG DISTRO
FROM ocaml/opam2:${DISTRO}

USER opam
WORKDIR /home/opam/src
RUN opam switch 4.07
COPY *.opam .
RUN opam pin add --no-action duniverse .
RUN opam update
RUN opam depext duniverse
RUN opam install --deps-only -t duniverse
COPY . .
RUN sudo chown -R opam /home/opam/src

# Checking that dune-project and the generated opam are in sync
RUN opam exec dune build duniverse.opam
RUN git diff --exit-code duniverse.opam \
    || (printf "\nERROR: The generated opam file isn't in sync with the dune-project\n" \
        && false)

RUN opam exec make
RUN opam exec make test
RUN opam exec make install
WORKDIR examples
RUN opam exec ./build-examples.sh
